# I Still Don't Care About Cookies - Developer Guide

## Project Overview

- **Purpose**: Browser extension that automatically removes cookie consent banners from websites
- **Language**: JavaScript (ES2021+)
- **Type**: Cross-browser extension (Chrome/Firefox/Edge)
- **License**: GPL-3.0
- **Version**: 1.1.4

## Key Technologies

- **Manifest V2** (Firefox) and **Manifest V3** (Chrome/Edge) support
- **ES Modules** (`"type": "module"` in package.json)
- **Chrome Extension APIs**: tabs, storage, webRequest, scripting, declarativeNetRequest
- **Internationalization**: 25+ languages via Crowdin
- **Build Tools**: ESLint, Prettier

## Project Structure

### Core Files
- `src/manifest_v2.json` - Firefox manifest (uses background page)
- `src/manifest_v3.json` - Chrome/Edge manifest (uses service worker)
- `src/data/background.js` - Main extension logic (service worker/background page)
- `src/data/rules.js` - Website-specific CSS/JS rules database
- `src/rules.json` - Declarative net request rules for Manifest V3

### UI Components
- `src/data/menu/` - Extension popup interface
- `src/data/options.html` - Settings page
- `src/data/css/common.css` - Common CSS rules applied to all sites

### JavaScript Handlers
- `src/data/js/0_defaultClickHandler.js` - Default cookie banner clicking logic
- `src/data/js/2_sessionStorageHandler.js` - Session storage manipulation
- `src/data/js/3_localStorageHandler.js` - Local storage manipulation
- `src/data/js/5_clickHandler.js` - Generic click handlers
- `src/data/js/6_cookieHandler.js` - Cookie manipulation
- `src/data/js/8_googleHandler.js` - Google-specific handlers
- `src/data/js/embedsHandler.js` - Social media embed handlers

### Internationalization
- `src/_locales/` - Translation files for 25+ languages
- `crowdin.yml` - Crowdin configuration for translation management

## Development Workflow

### Setup
```bash
npm install
```

### Code Quality
```bash
npm run lint          # Check code style
npm run lintfix       # Auto-fix linting issues
npm run prettier      # Format code
```

### Building
```bash
npm run build:chrome     # Build for Chrome (Manifest V3)
npm run build:chrome:dev # Development build for Chrome
```

### Manual Build Process
- **Chrome**: Copy `manifest_v3.json` to `manifest.json`, clear `hotreload.js`
- **Firefox**: Copy `manifest_v2.json` to `manifest.json`, use `web-ext build`

## Code Conventions

### ESLint Configuration
- **Base**: Google style guide + Prettier
- **Disabled Rules**: `max-len`, `require-jsdoc`, `no-multi-str`, `guard-for-in`
- **ES2021+** syntax with modules

### File Naming
- JavaScript handlers: `{priority}_{name}Handler.js` (e.g., `0_defaultClickHandler.js`)
- Priority determines execution order (0 = highest priority)

### Rules Database Structure
```javascript
// rules.js structure
const rules = {
  "domain.com": {
    s: "custom CSS",           // Site-specific CSS
    c: 0,                      // Common CSS rule index
    j: 0                       // Common JS handler index
  }
};

const commons = {
  0: "CSS rule",               // Reusable CSS rules
  1: "Another CSS rule"
};

const commonJSHandlers = {
  0: "0_defaultClickHandler",  // Maps to JS files
  2: "2_sessionStorageHandler"
};
```

### Block URL Structure
```javascript
const blockUrls = {
  common: [
    { r: "url-pattern", q: false, e: ["exception.com"] }
  ],
  common_groups: {
    "keyword": [/* grouped filters */]
  },
  specific: {
    "domain.com": ["blocked-path"]
  }
};
```

## Extension Architecture

### Manifest V2 vs V3 Differences
- **V2**: Background page, `webRequest` blocking, `chrome.tabs.insertCSS`
- **V3**: Service worker, `declarativeNetRequest`, `chrome.scripting.insertCSS`
- Code automatically detects manifest version and uses appropriate APIs

### Permission Usage
- `tabs` - Access tab information and inject scripts
- `storage` - Save user preferences (whitelist, settings)
- `webRequest`/`declarativeNetRequest` - Block cookie-related requests
- `scripting` - Inject CSS/JS into web pages
- `host_permissions` - Access all websites to remove cookie banners

### Content Injection Flow
1. `webNavigation.onCommitted` triggers `doTheMagic()`
2. Inject common CSS (`common.css`)
3. Check for site-specific rules in `rules.js`
4. Inject appropriate CSS/JS handlers
5. Fall back to default click handler if no specific rules

## Testing and Debugging

### Development Mode
- Use `hotreload.js` for development (auto-cleared in production builds)
- Enable "Developer mode" in browser extension settings
- Use browser developer tools to debug injected scripts

### Adding New Sites
1. Add rules to `src/data/rules.js`
2. Test with development build
3. Submit via GitHub issues or anonymous reporting

## Localization

### Adding Translations
- Base language: English (`src/_locales/en/messages.json`)
- Crowdin integration for community translations
- Use `chrome.i18n.getMessage()` for UI text

### Message Format
```json
{
  "messageName": {
    "message": "Text with $PLACEHOLDER$",
    "placeholders": {
      "placeholder": {
        "content": "$1"
      }
    }
  }
}
```

## CI/CD Pipeline

### GitHub Actions
- **Build**: Creates Chrome and Firefox builds on push
- **Localization**: Syncs translations with Crowdin
- **Release**: Automated release process
- **Block Rules**: Generates updated rule sets

### Artifacts
- `ISDCAC-chrome` - Chrome extension files
- `ISDCAC-firefox-unsigned` - Firefox .xpi file
- `ISDCAC-firefox-source` - Firefox source files

## Security Considerations

### Privacy
- No personal data collection
- Local storage only for user preferences
- Optional anonymous reporting to `api.istilldontcareaboutcookies.com`

### Content Security
- No `eval()` or dynamic code execution
- Minimal external API calls
- Open source backend for reporting API

## Contributing Guidelines

### Code Style
- Follow ESLint configuration
- Use Prettier for formatting
- Write descriptive commit messages
- Test on multiple browsers

### Adding Website Support
1. Identify cookie banner selectors
2. Add to appropriate section in `rules.js`
3. Test thoroughly
4. Consider edge cases and exceptions

### Performance
- Minimize CSS rule complexity
- Use efficient selectors
- Group similar rules under `common_groups`
- Avoid blocking main thread operations